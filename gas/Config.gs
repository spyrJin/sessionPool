/**
 * ============================================================
 * [Config.gs]
 * ì„¸ì…˜í’€ ì‹œìŠ¤í…œ ì „ì—­ ì„¤ì • ë° ìƒìˆ˜ ì •ì˜
 * ============================================================
 */

const CONFIG = {
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ê¸°ë³¸ ì„¤ì •
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  SHEET_NAME: 'SessionPool',      // ë©”ì¸ ì‹œíŠ¸ íƒ­ ì´ë¦„
  USER_DATA_SHEET_NAME: 'System_UserData',  // ì‚¬ìš©ì ë°ì´í„° ì €ì¥ìš© ìˆ¨ê¹€ ì‹œíŠ¸
  START_HOUR: 5,                   // í•˜ë£¨ ì‹œì‘ ì‹œê°„ (05:00)
  GATE_DURATION_MINUTES: 5,        // ê²Œì´íŠ¸ ì—´ë¦¼ ì‹œê°„ (ë¶„)
  BLOCK_DURATION_MINUTES: 30,      // ë¸”ë¡ ë‹¨ìœ„ (ë¶„)
  TOTAL_BLOCKS: 48,                // í•˜ë£¨ ì´ ë¸”ë¡ ìˆ˜ (48 * 30ë¶„ = 24ì‹œê°„)
  
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ê·¸ë£¹í™” ì„¤ì •
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  GROUP_MIN_SIZE: 2,               // ìµœì†Œ ê·¸ë£¹ ì¸ì›
  GROUP_MAX_SIZE: 3,               // ìµœëŒ€ ê·¸ë£¹ ì¸ì›
  
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ê´€ë¦¬ì ì´ë©”ì¼ ëª©ë¡
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ADMIN_EMAILS: [
    'admin@sessionpool.com',       // ì‹¤ì œ ê´€ë¦¬ì ì´ë©”ì¼ë¡œ êµì²´
    'jinmo0303@gmail.com'          // ì¶”ê°€ëœ ê´€ë¦¬ì
  ],
  
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ìƒ‰ìƒ íŒ”ë ˆíŠ¸
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  COLORS: {
    // í—¤ë”
    HEADER_BG: '#1A73E8',
    HEADER_TEXT: '#FFFFFF',
    
    // ì‹œê°„ ìƒíƒœ
    CURRENT_BLOCK: '#FFF3CD',      // í˜„ì¬ ë¸”ë¡ (ë…¸ë€ìƒ‰)
    LOCKED: '#F5F5F5',             // ì ê¹€/ì§€ë‚œ ë¸”ë¡ (íšŒìƒ‰)
    FUTURE: '#FFFFFF',             // ë¯¸ë˜ ë¸”ë¡ (í°ìƒ‰)
    
    // ì„¸ì…˜ íƒ€ì…
    IMMERSE: '#E3F2FD',            // ëª°ì… ë°°ê²½ (íŒŒë€ìƒ‰)
    IMMERSE_TEXT: '#1565C0',       // ëª°ì… ê¸€ì
    RECOVER: '#E8F5E9',            // íšŒë³µ ë°°ê²½ (ì´ˆë¡ìƒ‰)
    RECOVER_TEXT: '#2E7D32',       // íšŒë³µ ê¸€ì
    
    // ê²Œì´íŠ¸ ìƒíƒœ
    GATE_OPEN: '#C8E6C9',          // ê²Œì´íŠ¸ ì—´ë¦¼ (ì—°ë‘)
    GATE_CLOSED: '#FFCDD2',        // ê²Œì´íŠ¸ ë‹«í˜ (ì—°í•œ ë¹¨ê°•)
    
    // ì˜ˆì™¸ ìƒíƒœ
    WAITING: '#FFE0B2',            // ëŒ€ê¸° (ì£¼í™©)
    WAITING_TEXT: '#E65100',
    
    // ê·¸ë£¹ êµ¬ë¶„
    GROUP_BORDER: '#424242'        // ê·¸ë£¹ ê²½ê³„ì„ 
  },
  
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ê¸°ë³¸ ì½”í˜¸íŠ¸ ì„¤ì • (ëª¨ë“  ì‚¬ìš©ì ê¸°ë³¸ ì ‘ê·¼)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  DEFAULT_COHORT: '@ê°ì',
  
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ê¸°ë³¸ ì„¸ì…˜ ì˜µì…˜ (ëª¨ë“  ì‚¬ìš©ì)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  DEFAULT_SESSIONS: [
    'ëª°ì… @ê°ì',
    'íšŒë³µ @ê°ì'
  ],
  
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ì½”í˜¸íŠ¸ ì •ë³´ (í¬ë¦¬ì—ì´í„°ë³„ ì„¤ì •)
  // ì‹¤ì œ ìš´ì˜ ì‹œ Script Propertiesì—ì„œ ë™ì  ê´€ë¦¬
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  COHORTS: {
    '@ê°ì': {
      owner: 'system',
      rooms: [
        'https://meet.google.com/jqw-kgwm-oct',
        'https://meet.google.com/wwv-igfg-rfw',
        'https://meet.google.com/zao-awjn-kku'
      ],
      sessions: []  // ê¸°ë³¸ ì„¸ì…˜ì€ DEFAULT_SESSIONSì—ì„œ ê´€ë¦¬
    },
    '@session_pool': {
      owner: 'sessionpool@gmail.com',
      rooms: [
        'https://meet.google.com/jqw-kgwm-oct',
        'https://meet.google.com/wwv-igfg-rfw',
        'https://meet.google.com/zao-awjn-kku'
      ],
      sessions: ['05:00', '21:00']  // ì„¸ì…˜ ì‹œê°„
    },
    '@sloth_time': {
      owner: 'sloth@gmail.com',
      rooms: [
        'https://meet.google.com/sgx-uzjc-ruz',
        'https://meet.google.com/tcf-sgws-npv',
        'https://meet.google.com/ije-khhd-auh'
      ],
      sessions: ['15:00']  // êµ¬ê¸€í¼ ì‘ì„±ìë§Œ ì ‘ê·¼ ê°€ëŠ¥
    }
  },
  
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ìƒì„¤ ëŒ€ê¸°ë°© (Universal Poolì—ì„œë„ ë§¤ì¹­ ì•ˆ ëœ ìµœí›„ì˜ 1ì¸ìš©)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ì‚¬ìš©ì ë°ì´í„° í´ë” (êµ¬ê¸€í¼ ì‘ë‹µ ì‹œíŠ¸ë“¤ì´ ìˆëŠ” ê³³)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  USER_DATA_FOLDER_ID: '1dlDLaIjuzRR7lTxzS32bmTzK0RUzM1DJ',
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ì´ë©”ì¼ ì„œë¹„ìŠ¤ (Resend)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // API í‚¤ëŠ” Script Propertiesì—ì„œ 'RESEND_API_KEY'ë¡œ ê´€ë¦¬ (ë³´ì•ˆ)
  SENDER_EMAIL: 'onboarding@resend.dev', // í…ŒìŠ¤íŠ¸ìš© (í”„ë¡œë•ì…˜ ì‹œ ë„ë©”ì¸ ì¸ì¦ í›„ ë³€ê²½)
  LOBBY_ROOM: 'https://meet.google.com/sessionpool-lobby',
  
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ë©”ì‹œì§€ í…œí”Œë¦¿
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  MESSAGES: {
    GATE_OPEN: 'ğŸŸ¢ ì„ íƒ ê°€ëŠ¥',
    GATE_CLOSED: 'ğŸ”´ ëª°ì… ì¤‘',
    WAITING: 'â³ ëŒ€ê¸° ì¤‘ (íŒŒíŠ¸ë„ˆ ì°¾ëŠ” ì¤‘)',
    LOBBY: 'ğŸ  ëŒ€ê¸°ë°© (ëˆ„êµ°ê°€ ì˜¬ ë•Œê¹Œì§€)',
    NO_PERMISSION: 'âš ï¸ ê¶Œí•œ ì—†ìŒ',
    EDIT_DENIED: 'âš ï¸ í¸ì§‘ ë¶ˆê°€',
    NOT_YOUR_ROW: 'âš ï¸ ë³¸ì¸ í–‰ë§Œ í¸ì§‘ ê°€ëŠ¥',
    GATE_CLOSED_MSG: 'âš ï¸ ê²Œì´íŠ¸ê°€ ë‹«í˜”ìŠµë‹ˆë‹¤'
  }
};

/**
 * ì½”í˜¸íŠ¸ ì •ë³´ ì¡°íšŒ (Script Properties ìš°ì„ , ì—†ìœ¼ë©´ CONFIG)
 */
function getCohortConfig(cohortName) {
  // Script Propertiesì—ì„œ ë™ì  ì½”í˜¸íŠ¸ ì¡°íšŒ ì‹œë„
  const props = PropertiesService.getScriptProperties();
  const dynamicCohorts = JSON.parse(props.getProperty('cohorts') || '{}');
  
  if (dynamicCohorts[cohortName]) {
    return dynamicCohorts[cohortName];
  }
  
  // ê¸°ë³¸ CONFIGì—ì„œ ì¡°íšŒ
  return CONFIG.COHORTS[cohortName] || null;
}

/**
 * ì½”í˜¸íŠ¸ì˜ Meet ë°© ëª©ë¡ ì¡°íšŒ
 */
function getCohortRooms(cohortName) {
  const cohort = getCohortConfig(cohortName);
  return cohort ? cohort.rooms : CONFIG.COHORTS[CONFIG.DEFAULT_COHORT].rooms;
}

/**
 * ëª¨ë“  í™œì„± ì½”í˜¸íŠ¸ ëª©ë¡ ì¡°íšŒ
 */
function getAllCohorts() {
  const props = PropertiesService.getScriptProperties();
  const dynamicCohorts = JSON.parse(props.getProperty('cohorts') || '{}');

  // CONFIGì™€ ë™ì  ì½”í˜¸íŠ¸ ë³‘í•©
  const allCohorts = { ...CONFIG.COHORTS, ...dynamicCohorts };
  return Object.keys(allCohorts);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ì›ê²© ì‹œíŠ¸ ì œì–´ (ë§ˆìŠ¤í„° â†’ ì˜¤ëŠ˜ì˜ ì‹œíŠ¸)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const ACTIVE_SHEET_ID_KEY = 'activeSheetId';
const ACTIVE_SHEET_SET_AT_KEY = 'activeSheetSetAt';
const ACTIVE_SHEET_MAX_AGE_MS = 36 * 60 * 60 * 1000;  // 36ì‹œê°„

/**
 * í˜„ì¬ ìš´ì˜ ì¤‘ì¸ ì‹œíŠ¸ ID ì¡°íšŒ (TTL ìë™ ë§Œë£Œ í¬í•¨)
 * @returns {string|null} ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ID
 */
function getActiveSheetId() {
  const props = PropertiesService.getScriptProperties();
  const id = props.getProperty(ACTIVE_SHEET_ID_KEY);
  const setAt = props.getProperty(ACTIVE_SHEET_SET_AT_KEY);

  if (id && setAt) {
    const age = Date.now() - new Date(setAt).getTime();
    if (age > ACTIVE_SHEET_MAX_AGE_MS) {
      clearActiveSheetId();
      systemLog('CONFIG', 'í™œì„± ì‹œíŠ¸ ID ë§Œë£Œë¡œ ìë™ ì´ˆê¸°í™”', { age: Math.round(age / 3600000) + 'ì‹œê°„' });
      return null;
    }
  }

  return id;
}

/**
 * í˜„ì¬ ìš´ì˜ ì¤‘ì¸ ì‹œíŠ¸ ID ì„¤ì • (ìœ íš¨ì„± ê²€ì‚¬ í¬í•¨)
 * @param {string} sheetId - ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ID
 */
function setActiveSheetId(sheetId) {
  // ìœ íš¨ì„± ê²€ì‚¬
  if (!sheetId || typeof sheetId !== 'string' || sheetId.length < 10) {
    throw new Error('ìœ íš¨í•˜ì§€ ì•Šì€ ì‹œíŠ¸ ID í˜•ì‹: ' + sheetId);
  }

  // ì ‘ê·¼ ê°€ëŠ¥ì„± ê²€ì‚¬
  try {
    const ss = SpreadsheetApp.openById(sheetId);
    if (!ss.getSheetByName(CONFIG.SHEET_NAME)) {
      throw new Error('SessionPool ì‹œíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤');
    }
  } catch (e) {
    throw new Error('ì‹œíŠ¸ ì ‘ê·¼ ë¶ˆê°€: ' + sheetId + ' - ' + e.toString());
  }

  const props = PropertiesService.getScriptProperties();
  props.setProperty(ACTIVE_SHEET_ID_KEY, sheetId);
  props.setProperty(ACTIVE_SHEET_SET_AT_KEY, new Date().toISOString());
  systemLog('CONFIG', 'í™œì„± ì‹œíŠ¸ ID ë³€ê²½', { sheetId: sheetId });

  // ìºì‹œ ë¬´íš¨í™”
  if (typeof invalidateMainSheetCache === 'function') {
    invalidateMainSheetCache();
  }
}

/**
 * í™œì„± ì‹œíŠ¸ ID ì´ˆê¸°í™” (ë§ˆìŠ¤í„° ì‹œíŠ¸ë¡œ ë³µê·€)
 */
function clearActiveSheetId() {
  const props = PropertiesService.getScriptProperties();
  props.deleteProperty(ACTIVE_SHEET_ID_KEY);
  props.deleteProperty(ACTIVE_SHEET_SET_AT_KEY);
  systemLog('CONFIG', 'í™œì„± ì‹œíŠ¸ ID ì´ˆê¸°í™” (ë§ˆìŠ¤í„°ë¡œ ë³µê·€)');

  // ìºì‹œ ë¬´íš¨í™”
  if (typeof invalidateMainSheetCache === 'function') {
    invalidateMainSheetCache();
  }
}
