<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Google Sans', Roboto, Arial, sans-serif;
      background: #f8f9fa;
      color: #202124;
      padding: 16px;
      font-size: 14px;
    }
    
    /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .card-header {
      font-size: 12px;
      color: #5f6368;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    
    /* ìƒíƒœ í‘œì‹œ */
    .status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 18px;
      font-weight: 500;
    }
    
    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    
    .status-dot.open { background: #34a853; }
    .status-dot.closed { background: #ea4335; }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    /* íƒ€ì´ë¨¸ */
    .timer {
      font-size: 32px;
      font-weight: 700;
      color: #1a73e8;
      text-align: center;
      padding: 16px 0;
    }
    
    /* ì‚¬ìš©ì ì •ë³´ */
    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .user-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
      font-weight: bold;
    }
    
    .user-details {
      flex: 1;
    }
    
    .user-name {
      font-size: 16px;
      font-weight: 600;
    }
    
    .user-streak {
      color: #ea4335;
      font-size: 14px;
    }
    
    /* ì„¸ì…˜ ì„ íƒ */
    .session-select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      background: white;
      cursor: pointer;
      transition: border-color 0.2s;
    }
    
    .session-select:focus {
      outline: none;
      border-color: #1a73e8;
    }
    
    .session-select:disabled {
      background: #f5f5f5;
      cursor: not-allowed;
    }
    
    /* ë²„íŠ¼ */
    .btn {
      display: block;
      width: 100%;
      padding: 14px 20px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      text-align: center;
    }
    
    .btn-primary {
      background: #1a73e8;
      color: white;
    }
    
    .btn-primary:hover {
      background: #1557b0;
    }
    
    .btn-primary:disabled {
      background: #9aa0a6;
      cursor: not-allowed;
    }
    
    .btn-success {
      background: #34a853;
      color: white;
    }
    
    .btn-success:hover {
      background: #2d8e47;
    }
    
    .btn-secondary {
      background: #f1f3f4;
      color: #5f6368;
    }
    
    .btn-secondary:hover {
      background: #e8eaed;
    }
    
    /* íŒŒíŠ¸ë„ˆ ëª©ë¡ */
    .partners-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    
    .partner-chip {
      background: #e8f0fe;
      color: #1a73e8;
      padding: 4px 12px;
      border-radius: 16px;
      font-size: 12px;
    }
    
    /* ê³µì§€ì‚¬í•­ */
    .announcement {
      background: #fef7e0;
      border-left: 4px solid #f9ab00;
      padding: 12px;
      margin-bottom: 12px;
      border-radius: 0 8px 8px 0;
    }
    
    .announcement-title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    /* ë¡œë”© */
    .loading {
      text-align: center;
      padding: 40px;
      color: #5f6368;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #1a73e8;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* ì—ëŸ¬ ìƒíƒœ */
    .error-state {
      text-align: center;
      padding: 20px;
      color: #ea4335;
    }
    
    /* ë¯¸ë“±ë¡ ìƒíƒœ */
    .unregistered {
      text-align: center;
      padding: 20px;
    }
    
    .unregistered-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    
    /* ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ */
    .refresh-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      width: 100%;
      padding: 8px;
      background: none;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      color: #5f6368;
      font-size: 13px;
      cursor: pointer;
      margin-top: 12px;
    }
    
    .refresh-btn:hover {
      background: #f5f5f5;
    }
    
    /* ìˆ¨ê¹€ */
    .hidden { display: none; }
  </style>
</head>
<body>
  <!-- ë¡œë”© ìƒíƒœ -->
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <p>ë¡œë”© ì¤‘...</p>
  </div>
  
  <!-- ë¯¸ë“±ë¡ ì‚¬ìš©ì -->
  <div id="unregistered" class="unregistered hidden">
    <div class="unregistered-icon">ğŸ‘‹</div>
    <h2>í™˜ì˜í•©ë‹ˆë‹¤!</h2>
    <p style="margin: 12px 0; color: #5f6368;">
      ì•„ì§ ë“±ë¡ë˜ì§€ ì•Šì€ ì‚¬ìš©ìì…ë‹ˆë‹¤.<br>
      ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.
    </p>
    <div id="user-email" style="font-size: 12px; color: #9aa0a6; margin-top: 8px;"></div>
  </div>
  
  <!-- ë©”ì¸ ì½˜í…ì¸  -->
  <div id="main-content" class="hidden">
    <!-- ê³µì§€ì‚¬í•­ -->
    <div id="announcement" class="announcement hidden">
      <div class="announcement-title">ğŸ“¢ ê³µì§€ì‚¬í•­</div>
      <div id="announcement-text"></div>
    </div>
    
    <!-- ê²Œì´íŠ¸ ìƒíƒœ -->
    <div class="card">
      <div class="card-header">í˜„ì¬ ìƒíƒœ</div>
      <div class="status-indicator">
        <div id="status-dot" class="status-dot"></div>
        <span id="status-text">í™•ì¸ ì¤‘...</span>
      </div>
      <div class="timer" id="timer">--:--</div>
      <div style="text-align: center; color: #5f6368; font-size: 12px;">
        í˜„ì¬ ë¸”ë¡: <span id="current-block">--:--</span>
      </div>
    </div>
    
    <!-- ì‚¬ìš©ì ì •ë³´ -->
    <div class="card">
      <div class="card-header">ë‚´ ì •ë³´</div>
      <div class="user-info">
        <div class="user-avatar" id="user-avatar">?</div>
        <div class="user-details">
          <div class="user-name" id="user-name">@username</div>
          <div class="user-streak" id="user-streak">ğŸ”¥ 0ì¼ ì—°ì†</div>
        </div>
      </div>
    </div>
    
    <!-- ì„¸ì…˜ ì„ íƒ -->
    <div class="card" id="session-card">
      <div class="card-header">ì„¸ì…˜ ì„ íƒ</div>
      <select id="session-select" class="session-select">
        <option value="">ì„ íƒí•˜ì„¸ìš”...</option>
      </select>
      <button id="select-btn" class="btn btn-primary" style="margin-top: 12px;" onclick="selectSession()">
        ì„ íƒí•˜ê¸°
      </button>
    </div>
    
    <!-- Meet ì…ì¥ (ë§¤ì¹­ ì™„ë£Œ ì‹œ) -->
    <div class="card hidden" id="meet-card">
      <div class="card-header">ë§¤ì¹­ ì™„ë£Œ!</div>
      <div id="session-value" style="font-size: 16px; font-weight: 600; margin-bottom: 12px;"></div>
      
      <div id="partners-section">
        <div style="font-size: 12px; color: #5f6368; margin-bottom: 4px;">íŒŒíŠ¸ë„ˆ</div>
        <div class="partners-list" id="partners-list"></div>
      </div>
      
      <a id="meet-link" href="#" target="_blank" class="btn btn-success" style="margin-top: 16px;">
        ğŸš€ Meet ì…ì¥í•˜ê¸°
      </a>
    </div>
    
    <!-- ìƒˆë¡œê³ ì¹¨ -->
    <button class="refresh-btn" onclick="refresh()">
      ğŸ”„ ìƒˆë¡œê³ ì¹¨
    </button>
  </div>

  <script>
    // ìƒíƒœ ì €ì¥
    let currentData = null;
    let refreshInterval = null;
    
    // ì´ˆê¸° ë¡œë“œ
    document.addEventListener('DOMContentLoaded', function() {
      loadData();
      startAutoRefresh();
    });
    
    // ìë™ ìƒˆë¡œê³ ì¹¨ (5ì´ˆ)
    function startAutoRefresh() {
      if (refreshInterval) clearInterval(refreshInterval);
      refreshInterval = setInterval(loadData, 5000);
    }
    
    // ë°ì´í„° ë¡œë“œ
    function loadData() {
      google.script.run
        .withSuccessHandler(updateUI)
        .withFailureHandler(showError)
        .getSidebarData();
    }
    
    // UI ì—…ë°ì´íŠ¸
    function updateUI(data) {
      currentData = data;
      
      // ë¡œë”© ìˆ¨ê¹€
      document.getElementById('loading').classList.add('hidden');
      
      // ë¯¸ë“±ë¡ ì‚¬ìš©ì
      if (!data.registered) {
        document.getElementById('unregistered').classList.remove('hidden');
        document.getElementById('main-content').classList.add('hidden');
        document.getElementById('user-email').textContent = data.email;
        return;
      }
      
      // ë©”ì¸ ì½˜í…ì¸  í‘œì‹œ
      document.getElementById('unregistered').classList.add('hidden');
      document.getElementById('main-content').classList.remove('hidden');
      
      // ê³µì§€ì‚¬í•­
      if (data.announcement) {
        document.getElementById('announcement').classList.remove('hidden');
        document.getElementById('announcement-text').textContent = data.announcement;
      } else {
        document.getElementById('announcement').classList.add('hidden');
      }
      
      // ê²Œì´íŠ¸ ìƒíƒœ
      const statusDot = document.getElementById('status-dot');
      const statusText = document.getElementById('status-text');
      
      if (data.gateStatus.isOpen) {
        statusDot.className = 'status-dot open';
        statusText.textContent = 'ğŸŸ¢ ì„ íƒ ê°€ëŠ¥';
      } else {
        statusDot.className = 'status-dot closed';
        statusText.textContent = 'ğŸ”´ ëª°ì… ì¤‘';
      }
      
      // íƒ€ì´ë¨¸
      document.getElementById('timer').textContent = data.gateStatus.displayTime;
      document.getElementById('current-block').textContent = data.currentBlock.label;
      
      // ì‚¬ìš©ì ì •ë³´
      document.getElementById('user-avatar').textContent = data.instagram.charAt(1).toUpperCase();
      document.getElementById('user-name').textContent = data.instagram;
      document.getElementById('user-streak').textContent = 'ğŸ”¥ ' + data.streak + 'ì¼ ì—°ì†';
      
      // Meet ë§í¬ê°€ ìˆìœ¼ë©´ (ë§¤ì¹­ ì™„ë£Œ)
      if (data.meetLink) {
        document.getElementById('session-card').classList.add('hidden');
        document.getElementById('meet-card').classList.remove('hidden');
        document.getElementById('session-value').textContent = data.sessionValue;
        document.getElementById('meet-link').href = data.meetLink;
        
        // íŒŒíŠ¸ë„ˆ í‘œì‹œ
        const partnersList = document.getElementById('partners-list');
        partnersList.innerHTML = '';
        if (data.partners && data.partners.length > 0) {
          data.partners.forEach(function(partner) {
            const chip = document.createElement('span');
            chip.className = 'partner-chip';
            chip.textContent = partner;
            partnersList.appendChild(chip);
          });
        } else {
          document.getElementById('partners-section').classList.add('hidden');
        }
      } else {
        // ì„¸ì…˜ ì„ íƒ ê°€ëŠ¥
        document.getElementById('session-card').classList.remove('hidden');
        document.getElementById('meet-card').classList.add('hidden');
        
        // ì„¸ì…˜ ì˜µì…˜ ë¡œë“œ (ì˜µì…˜ì´ ì—†ê±°ë‚˜ ì´ˆê¸° ìƒíƒœì¼ ë•Œë§Œ ë¡œë“œí•˜ì—¬ ì„ íƒ ì´ˆê¸°í™” ë°©ì§€)
        const select = document.getElementById('session-select');
        if (select.options.length <= 1) {
          loadSessionOptions();
        }
        
        // ê²Œì´íŠ¸ ë‹«í˜€ìˆìœ¼ë©´ ë¹„í™œì„±í™”
        const selectBtn = document.getElementById('select-btn');
        
        if (!data.gateStatus.isOpen) {
          select.disabled = true;
          selectBtn.disabled = true;
          selectBtn.textContent = 'ê²Œì´íŠ¸ ë‹«í˜';
        } else {
          select.disabled = false;
          selectBtn.disabled = false;
          selectBtn.textContent = 'ì„ íƒí•˜ê¸°';
        }
      }
    }
    
    // ì„¸ì…˜ ì˜µì…˜ ë¡œë“œ
    function loadSessionOptions() {
      google.script.run
        .withSuccessHandler(function(options) {
          const select = document.getElementById('session-select');
          // ê¸°ì¡´ ì„ íƒê°’ ë³´ì¡´ ì‹œë„
          const currentValue = select.value;
          
          select.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”...</option>';
          
          options.forEach(function(option) {
            const opt = document.createElement('option');
            opt.value = option;
            opt.textContent = option;
            select.appendChild(opt);
          });
          
          // ê°’ì´ ì—¬ì „íˆ ìœ íš¨í•˜ë‹¤ë©´ ë³µì›
          if (currentValue && Array.from(select.options).some(opt => opt.value === currentValue)) {
            select.value = currentValue;
          }
        })
        .getSessionOptions();
    }
    
    // ì„¸ì…˜ ì„ íƒ
    function selectSession() {
      const value = document.getElementById('session-select').value;
      if (!value) {
        alert('ì„¸ì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
      
      const btn = document.getElementById('select-btn');
      btn.disabled = true;
      btn.textContent = 'ì²˜ë¦¬ ì¤‘...';
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            loadData();
            // ì„±ê³µ ì•Œë¦¼ (ì„ íƒì )
            // alert(result.message);
          } else {
            alert(result.message);
            btn.disabled = false;
            btn.textContent = 'ì„ íƒí•˜ê¸°';
          }
        })
        .withFailureHandler(function(error) {
          alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error);
          btn.disabled = false;
          btn.textContent = 'ì„ íƒí•˜ê¸°';
        })
        .selectSession(value);
    }
    
    // ìƒˆë¡œê³ ì¹¨
    function refresh() {
      document.getElementById('loading').classList.remove('hidden');
      document.getElementById('main-content').classList.add('hidden');
      loadData();
    }
    
    // ì—ëŸ¬ ì²˜ë¦¬
    function showError(error) {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('main-content').innerHTML = 
        '<div class="error-state">' +
        '<p>âš ï¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</p>' +
        '<p style="font-size: 12px; margin-top: 8px;">' + error + '</p>' +
        '<button class="btn btn-secondary" style="margin-top: 16px;" onclick="refresh()">ë‹¤ì‹œ ì‹œë„</button>' +
        '</div>';
      document.getElementById('main-content').classList.remove('hidden');
    }
  </script>
</body>
</html>
